<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GNU Guix Guide &mdash; librepup</title>
  <meta name="description" content="librepup's GNU Guix Guide." />
  <link rel="stylesheet" href="../style.css" />
  <link rel="stylesheet" href="../highlightjs.default.css" />
  <script src="../js/highlight.min.js"></script>
</head>
<body>
  <script>hljs.highlightAll();</script>

  <header>
    <div class="site-wrapper">
      <a class="site-title" href="../index.html">~/librepup</a>
      <nav>
        <a href="../index.html">home</a>
        <a href="../blogs.html">blog</a>
        <a href="../about.html">about</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="site-wrapper">
      <article>

        <div class="article-header">
          <h1>GNU Guix Guide</h1>
          <p class="article-meta">
            by librepup &mdash;
            <span class="tag">gnu</span><span class="tag">linux</span><span class="tag">free software</span><span class="tag">guix</span><span class="tag">guide</span>
          </p>
          <a href="./guixguide_easy.html">[simple speech]</a>
        </div>

        <div class="article-body">

          <h2>Introduction</h2>

          <p>
            In this Article I will try to explain everything in regards to how my GNU Guix journey went, the hardships I went through, the lessons I learnt, and the system I eventually ended up with. I will go over installing custom channels, setting up proprietary kernels and graphics drivers,- everything from installing basic packages, to managing your entire home environment and configuration setup with Guix Home. Enjoy the ride!
          </p>

          <h3>Basics</h3>

          <p>
            To begin your GNU Guix journey, you first need to create a <a>config.scm</a> file somewhere on your machine. This will be your GNU Guix system configuration. We'll get into Guix Home a bit later. For now, let's focus on getting a simple system configuration up and running. We'll define a <a>%guix-os</a> variable, which will contain our entire system expression/definition. In this example we will use <a href="https://gitlab.com/nonguix/nonguix">nonguix</a> for proprietary kernel builds, firmware, initrd, and more. Let's start with a simple <a>(operating-system)</a> block:
          </p>

          <pre><code class="language-scheme">
(define %guix-os (operating-system
 (kernel linux)
 (initrd microcode-initrd)
 (firmware (append (list intel-microcode linux-firmware) %base-firmware))
 (hostname "guix")
 (timezone "Europe/Berlin")
 (locale "en_US.utf8")
 (keyboard-layout (keyboard-layout "us" "colemak"))
))
          </code></pre>

          <br>
          <p>
            But <b>wait</b>! We forgot the most important part! To make use of custom packages, kernels, firmware, transformations, and more - we first need to use all the necessary modules that provide these options. Technically we also need to add the channels we want to use <i>first</i>, but we'll get to that later. For now: we will add a few <a>(use-modules)</a> to our <a>config.scm</a>, as well as <a>(use-service-modules)</a> and <a>(use-package-modules)</a> to make our <a>config.scm</a> <b>desktop ready</b>:
          </p>

          <pre><code class="language-scheme">
(use-modules (gnu)
             (gnu system)
             (gnu system nss)
             (gnu packages)
             (gnu packages xorg)
             (gnu packages certs)
             (gnu packages shells)
             (gnu packages admin)
             (gnu packages base)
             (gnu services)
             (gnu services xorg)
             (gnu services desktop)
             (gnu services nix) ; Optional, you can remove this if you want.
             (gnu services sound)
             (gnu services audio)
             (gnu services networking)
             (gnu services virtualization) ; Optional, you can remove this if you want.
             (guix)
             (guix utils)
             ; Nongnu & Nonguix
             (nongnu packages linux)
             (nongnu packages nvidia)
             (nongnu services nvidia)
             (nongnu system linux-initrd)
             (nonguix transformations)
             ; Jonabron
             (jonabron packages wm)
             (jonabron packages fonts)
             (jonabron packages games)
             (jonabron packages communication))

(use-service-modules desktop sound audio networking ssh xorg dbus)
(use-package-modules wm bootloaders certs shells version-control xorg)

(define %guix-os (operating-system
 (kernel linux)
 (initrd microcode-initrd)
 (firmware (append (list intel-microcode linux-firmware) %base-firmware))
 (hostname "guix")
 (timezone "Europe/Berlin")
 (locale "en_US.utf8")
 (keyboard-layout (keyboard-layout "us" "colemak"))
))
          </code></pre>

          <br>
          <p>
            This may look like a lot of things we've just added, but it's mostly just necessary modules and a few modules/imports from custom channels. We just added:
          </p>
            <ul class="post-list">
              <li>
                <p> - Necessary <a>(gnu)</a> and <a>(guix)</a> modules.</p>
                <p> - Modules from the <a href="https://gitlab.com/nonguix/nonguix">nonguix</a> channel.</p>
                <p> - And modules from the <a href="https://github.com/librepup/jonabron">jonabron</a> channel.</p>
              </li>
            </ul>

            <br>
          <p>
            Now we can add our user account, this is pretty straight-forward: you pick a username, add your newly created user to a few groups, and optionally set the users default shell, here - let me show you:
          </p>
          <pre><code class="language-scheme">
; ... (use-modules), (use-service-modules), and (use-package-modules) above here.

(define %guix-os (operating-system
 (kernel linux)
 (initrd microcode-initrd)
 (firmware (append (list intel-microcode linux-firmware) %base-firmware))
 (hostname "guix")
 (timezone "Europe/Berlin")
 (locale "en_US.utf8")
 (keyboard-layout (keyboard-layout "us" "colemak"))
 (users (cons (user-account
               (name "puppy")
               (comment "Puppy")
               (group "users")
               (home-directory "/home/puppy")
               (supplementary-groups '("wheel" "netdev" "audio" "video" "input" "tty" "nixbld"))
               (shell (file-append zsh "/bin/zsh")))
              %base-user-accounts))
))
          </code></pre>
          <br>
          <p>
            Now we need to configure the bootloader and the file-systems. In this example I will use an <a>(U)EFI</a> compatible layout. Configuration code snippets for <a>Legacy/BIOS</a> systems are attached at the end of this Article. Either way, let's begin:
          </p>
          <pre><code class="language-scheme">

; ... (use-modules), (use-service-modules), and (use-package-modules) above here.

(define %guix-os (operating-system
 (kernel linux)
 (initrd microcode-initrd)
 (firmware (append (list intel-microcode linux-firmware) %base-firmware))
 (hostname "guix")
 (timezone "Europe/Berlin")
 (locale "en_US.utf8")
 (keyboard-layout (keyboard-layout "us" "colemak"))
 ; Added (bootloader) and (file-systems) here:
 (bootloader (bootloader-configuration
              (keyboard-layout keyboard-layout)
              (bootloader grub-efi-bootloader)
              (targets '("/boot/efi"))))
 (file-systems (cons* (file-system
                       (mount-point "/")
                       (device (file-system-label "guix-root"))
                       (type "ext4"))
                      (file-system
                       (mount-point "/boot/efi")
                       (device (file-system-label "guix-efi"))
                       (type "vfat"))
                      %base-file-systems))
 (users (cons (user-account
               (name "puppy")
               (comment "Puppy")
               (group "users")
               (home-directory "/home/puppy")
               (supplementary-groups '("wheel" "netdev" "audio" "video" "input" "tty" "nixbld"))
               (shell (file-append zsh "/bin/zsh")))
              %base-user-accounts))
))
          </code></pre>
          <br>
          <p>
            Now is a good time to talk about packages. On GNU Guix, packages are provided by channels. You can view your currently available and configured channels with the command <a>guix describe</a>. This article assumes you have set up the <a>nonguix</a>, <a>emacs</a>, <a>jonabron</a>, and of course the default/base <a>guix</a> channel. <i>How</i> you do that, will be explained later. For now, let's get to installing some packages:
          </p>
          <pre><code class="language-scheme">

; ... (use-modules), (use-service-modules), and (use-package-modules) above here.

(define %guix-os (operating-system
 (kernel linux)
 (initrd microcode-initrd)
 (firmware (append (list intel-microcode linux-firmware) %base-firmware))
 (hostname "guix")
 (timezone "Europe/Berlin")
 (locale "en_US.utf8")
 (keyboard-layout (keyboard-layout "us" "colemak"))
 ; Added (bootloader) and (file-systems) here:
 (bootloader (bootloader-configuration
              (keyboard-layout keyboard-layout)
              (bootloader grub-efi-bootloader)
              (targets '("/boot/efi"))))
 (file-systems (cons* (file-system
                       (mount-point "/")
                       (device (file-system-label "guix-root"))
                       (type "ext4"))
                      (file-system
                       (mount-point "/boot/efi")
                       (device (file-system-label "guix-efi"))
                       (type "vfat"))
                      %base-file-systems))
 (users (cons (user-account
               (name "puppy")
               (comment "Puppy")
               (group "users")
               (home-directory "/home/puppy")
               (supplementary-groups '("wheel" "netdev" "audio" "video" "input" "tty" "nixbld"))
               (shell (file-append zsh "/bin/zsh")))
              %base-user-accounts))

 (packages (append
            (map specification->package
                '("eza"
                  "bat"
                  "zoxide"
                  "ripgrep"
                  "grep"
                  "coreutils"
                  "glibc-locales"
                  "ncurses"
                  "zsh"
                  "git-minimal"
                  "emacs-no-x"
                  "usbutils"
                  "pciutils"
                  "wpa-supplicant"
                  "dhcpcd"
                  "naitre"
                  "xmonad"
                  "ghc-xmonad-contrib"
                  "procps"
                  "wget"
                  "curl"
                  "nss-certs"
                  "bash"
                  "sed"
                  "kitty"
                  )
                )
            ))
))
          </code></pre>
          <br>
          <p>
            Now comes the juicy part: <b>services</b>. We will set up a few services, some of which I consider necessary, and some which are purely optional (such as the <a>hurd-vm-service-type</a>, or the <a>nix-service-type</a>). What's important to know is that the <a>(modify-services)</a> block/option not only <i>modifies</i> a gives set of services, it also outputs the entire modified service definition <b>including all unmodified services</b> back to the system/configuration. This means that we can take a look at the <a href="https://codeberg.org/guix/guix/src/branch/master/gnu/services/desktop.scm">codeberg:guix/guix-gnu/services/desktop.scm</a> services definition to see which services are included in our <a>%desktop-services</a> block, the one we are modifying, and do not need to include any service that is already included in the <a>%desktop-services</a> again. If we want to remove a service which is present in the <a>%desktop-services</a> module, we can simple add <a>(delete [service]-service-type)</a>. Below I defined a few services:
          </p>
          <pre><code class="language-scheme">
; ... (use-modules), (use-service-modules), and (use-package-modules) above here.
(define %guix-os (operating-system
; ... rest of the (operating-system) definition from before above here.
 (services
  (append
   (list
    ; Hurd-VM Service, this is optional and can be removed if you want to.
    (service hurd-vm-service-type
	     (hurd-vm-configuration
	      (memory-size 2048)
	      (secret-directory "/etc/guix/hurd-secrets")))
    (service gnome-desktop-service-type)
    (service nix-service-type) ; This Nix Service can also be removed if you don't need it.
    (simple-service 'doas-config etc-service-type
                    (list
                     `("doas.conf" ,(plain-file "doas.conf"
"permit nopass keepenv root
permit persist keepenv setenv :wheel"))))
    (set-xorg-configuration
     (xorg-configuration
      (keyboard-layout keyboard-layout)
      ; These 2 lines below are used to set up Nvidia Drivers under Xorg.
      (modules (cons nvidia-driver %default-xorg-modules))
      (drivers '("nvidia")))))

   (modify-services %desktop-services
                    (gdm-service-type config =>
                                      (gdm-configuration
                                       (inherit config)
                                       (wayland? #t)))
                    (guix-service-type config =>
                                       (guix-configuration
                                        (inherit config)
                                        (substitute-urls
                                         (append (list "https://ci.guix.gnu.org"
                                               "https://berlin.guix.gnu.org"
                                               "https://bordeaux.guix.gnu.org"
                                               "https://substitutes.nonguix.org"
                                               "https://hydra-guix-129.guix.gnu.org"
                                               "https://substitutes.guix.gofranz.com")
                                                 %default-substitute-urls))
                                        (authorized-keys
                                         (append (list (local-file "/etc/guix/files/keys/nonguix.pub"))
                                                 %default-authorized-guix-keys))
                                        ))
                    (mingetty-service-type config =>
                                           (mingetty-configuration
                                            (inherit config)
                                            (auto-login "puppy")))
                    )
   ))
          </code></pre>
          <br>
          <p>
            We're almost done now. The last missing piece, is the <i>nonguix transformation</i> used to enable proprietary Nvidia Drivers. For that, we simply add the following code-block right at the <b>end</b> of our <a>config.scm</a>:
          </p>
          <pre><code class="language-scheme">
((compose (nonguix-transformation-nvidia))
 %guix-os)
          </code></pre>
          <br>

          <p>
            And this is it! This is what our complete <a>config.scm</a> now looks like. This configuration is fully functionaly, declares and configures everything we need to get a working system up and running, and more!
          </p>
          <pre><code class="language-scheme">
(use-modules (gnu)
             (gnu system)
             (gnu system nss)
             (gnu packages)
             (gnu packages xorg)
             (gnu packages certs)
             (gnu packages shells)
             (gnu packages admin)
             (gnu packages base)
             (gnu services)
             (gnu services xorg)
             (gnu services desktop)
             (gnu services nix)
             (gnu services sound)
             (gnu services audio)
             (gnu services networking)
             (gnu services virtualization)
             (guix)
             (guix utils)
             ; Nongnu & Nonguix
             (nongnu packages linux)
             (nongnu packages nvidia)
             (nongnu services nvidia)
             (nongnu system linux-initrd)
             (nonguix transformations)
             ; Jonabron
             (jonabron packages wm)
             (jonabron packages fonts)
             (jonabron packages games)
             (jonabron packages communication))

(use-service-modules desktop sound audio networking ssh xorg dbus)
(use-package-modules wm bootloaders certs shells version-control xorg)

(define %guix-os (operating-system
 (kernel linux)
 (initrd microcode-initrd)
 (firmware (append (list intel-microcode linux-firmware) %base-firmware))
 (host-name "guix")
 (timezone "Europe/Berlin")
 (locale "en_US.utf8")
 (keyboard-layout (keyboard-layout "us" "colemak"))

 (bootloader (bootloader-configuration
              (keyboard-layout keyboard-layout)
              (bootloader grub-efi-bootloader)
              (targets '("/boot/efi"))))

 (file-systems (cons* (file-system
                       (mount-point "/")
                       (device (file-system-label "guix-root"))
                       (type "ext4"))
                      (file-system
                       (mount-point "/boot/efi")
                       (device (file-system-label "guix-efi"))
                       (type "vfat"))
                      %base-file-systems))

 (users (cons (user-account
               (name "puppy")
               (comment "Puppy")
               (group "users")
               (home-directory "/home/puppy")
               (supplementary-groups '("wheel" "netdev" "audio" "video" "input" "tty" "nixbld"))
               (shell (file-append zsh "/bin/zsh")))
              %base-user-accounts))

 (packages (append
            (map specification->package
                '("eza"
                  "bat"
                  "zoxide"
                  "ripgrep"
                  "grep"
                  "coreutils"
                  "glibc-locales"
                  "ncurses"
                  "zsh"
                  "git-minimal"
                  "emacs-no-x"
                  "usbutils"
                  "pciutils"
                  "wpa-supplicant"
                  "dhcpcd"
                  "naitre"
                  "xmonad"
                  "ghc-xmonad-contrib"
                  "procps"
                  "wget"
                  "curl"
                  "nss-certs"
                  "bash"
                  "sed"
                  "kitty"
                  )
                )
            ))

 (services
  (append
   (list
    (service hurd-vm-service-type
	     (hurd-vm-configuration
	      (memory-size 2048)
	      (secret-directory "/etc/guix/hurd-secrets")))
    (service gnome-desktop-service-type)
    (service nix-service-type)
    (simple-service 'doas-config etc-service-type
                    (list
                     `("doas.conf" ,(plain-file "doas.conf"
"permit nopass keepenv root
permit persist keepenv setenv :wheel"))))
    (set-xorg-configuration
     (xorg-configuration
      (keyboard-layout keyboard-layout)
      (modules (cons nvidia-driver %default-xorg-modules))
      (drivers '("nvidia")))))

   (modify-services %desktop-services
                    (gdm-service-type config =>
                                      (gdm-configuration
                                       (inherit config)
                                       (wayland? #t)))
                    (guix-service-type config =>
                                       (guix-configuration
                                        (inherit config)
                                        (substitute-urls
                                         (append (list "https://ci.guix.gnu.org"
                                               "https://berlin.guix.gnu.org"
                                               "https://bordeaux.guix.gnu.org"
                                               "https://substitutes.nonguix.org"
                                               "https://hydra-guix-129.guix.gnu.org"
                                               "https://substitutes.guix.gofranz.com")
                                                 %default-substitute-urls))
                                        (authorized-keys
                                         (append (list (local-file "/etc/guix/files/keys/nonguix.pub"))
                                                 %default-authorized-guix-keys))
                                        ))
                    (mingetty-service-type config =>
                                           (mingetty-configuration
                                            (inherit config)
                                            (auto-login "puppy")))
                    )
   ))
 )
)

((compose (nonguix-transformation-nvidia))
 %guix-os)
          </code></pre>


        </div>

        <hr class="divider" />
        <p style="font-size:0.85rem; color: var(--fg-dim);">
          &larr; <a href="../blogs.html">back to all posts</a>
        </p>

      </article>
    </div>
  </main>

  <footer>
    <div class="site-wrapper">
      <p>&copy; librepup &mdash; built with free software &amp; plain HTML</p>
    </div>
  </footer>

</body>
</html>
